# 基于Linux的博客平台搭建

## 目录
- [技术栈](#技术栈)
- [功能改进与添加](#功能改进与添加)
- [更新日志](#更新日志)
- [未来规划](#未来规划)
- [常见问题](#常见问题)
- [参考资料](#参考资料)

## 技术栈

本平台主要使用以下技术栈：

- **编程语言**: C++，用于服务器端开发
- **数据库**: MySQL，用于存储博客数据、用户信息等
- **前端**: HTML, CSS, JavaScript（AJAX）用于页面展示与交互
- **框架与库**: 
  - `editor.md`: 用于Markdown编辑的富文本编辑器
- **服务器环境**:
  - **操作系统**: Linux（CentOS_7_9）
  - **Web服务器**: 自定义C++编写的Web服务器
  - **部署**：部署于阿里云服务器
  - **API协议**: RESTful API，用于前后端通信
  - **代理与缓存**: 使用Nginx作为反向代理与负载均衡？

## 功能改进与添加

### 2024-11-14之前的进度没有进行系统记录

### 2024-11-14（数据库的编码问题和JSON字符串中特殊字符的转换）
1. 客户端传入的json字符串在插入MySQL数据库时，插入的中文字符串（博客的标题和内容）会变成乱码。经过排查，从客户端发送的json字符串，到后端代码对于字符串的解析，cout出来的内容都没有乱码，因此将问题定位到插入到数据库的那一步。
   - 在遇到中文乱码时如何进行排查：
     - 确保数据库是**uft8mb4**或**utf8**等支持中文的字符集
     - 数据库连接（这个后端里面的代码）是否设置为**uft8mb4**或**utf8**
     - 发送过来的title和content也要确保是UTF-8？？？
2. 还有一个是从数据库中取出数据构建json字符串时，因为没有注意特殊字符（回车、换行、空格等），导致json字符串的构建（没有时间json库，自己手工构建的）有问题，客户端那边也因此无法正常解析并渲染。
   - 添加了转义字符处理函数，用于处理具有特殊含义的字符(" \ \n \r \t 等)
3. 后面的话要把json字符串的构建和转义字符处理函数封装到其它地方

### 2024-11-15(打算实现博客的分页查找，但是没搞定)
1. 对每个页面都添加了留言板的跳转路径。
2. 将blog_home.html的js代码分离出来，单独放进js文件夹。
3. 今天的进度没怎么推进(sad..)。

### 2024-11-16(博客的分页查询)
1. 实现了**数据库分页查询**和**获取数据库博客总条数**的接口
2. 前端博客首页添加了翻页按钮，在js中实现了滚动加载的功能
3. 后端添加了**get_blogs**接口,用于解析blog_home.html前端发送的异步Ajax
4. 使用shell脚本插入新博客用于测试，很方便（👍）

### 2024-11-17
1. 在主页面添加了一个可拖动下拉框，用于个人中心、作者信息等的界面跳转(floating_dropdown.html/js)
2. 在将游客主页的分页查询添加到用户主页时，js代码执行异常。经排查，是**script**标签中未使用**defer**属性，导致blog_user_home.html页面未解析完毕就已经执行完js脚本，使js脚本获取到的内容无法插入到主页面。  
注：defer：脚本会在解析页面的同时并行下载，并在页面解析成功后执行
3. 将游客和用户的主页进行相对同步(目前的差别是用户信息的板块多了一个Ajax请求用于获取用户信息)

### 2024-11-18
1. 完成了个人中心的前端页面样式，后续实现前后端交互
2. 在注册的时候出现报错，用户成功注册，但是服务端没有返回任何内容给客户端。  
经过断点排查，**http_conn::HTTP_CODE http_conn::do_request()**函数中存储else if冲突，使用**strstr**进行字符串判断，会导致**blog**和**blog_login**都能被检测。
3. 添加了点击博客详情时，也显示作者的部分信息。  
为实现上述功能，添加了**根据博客id获取用户id**，**根据用户id获取用户信息**，以及添加了用户数据库的内容（头像地址、文章数、注册时间、email）。

### 2024-11-19
1. 登录可以获取用户信息，显示在用户主页上（如用户头像、用户名、用户发布的文章数），现在还没有添加文章数的功能，先自行修改数据库测试

### 2024-11-26
1. 添加了**通过用户id获取该用户的所有博客**
2. 实现了个人中心里面的个人资料和博客管理前端页面及对应后端的响应
3. 今天遇到的一个最大问题就是，后端返回的json数据，即使只是多了一个`，`也会导致前端的页面无法渲染，需要注意

### 2024-11-27
1. 实现了博客内容的修改，另外添加了一个blog_editor_modify.html用于对已有博客的编辑
2. 实现了博客的删除功能
3. 实现了用户密码的修改，前端页面那些等功能做的差不多了再进行美化

### 2024-12-7(在博客详情添加评论区)
1. 新增评论类、评论表以及对应的数据库操作
2. 游客：能看评论，不能发评论用户：能看评论，能发评论
3. 没有系统学习前端的话感觉界面还是有点难整

### 2024-12-8(添加消息类，完成消息中心的前端界面)
1. 创建了新的数据库消息表，用于存储系统信息、点赞信息、评论信息等
2. 添加了消息类，暂未编写响应的数据库操作
3. 算是完成了消息中心的前端界面，后续补充后端接口就行了

### 2024-12-13(完成部分消息中心的功能)
1. 对js代码进行部分修改，使前端可以获取到数据库的消息数据
2. 完成了“标记已读”的功能(使用patch修改is_read，其实还是用的POST)
3. 添加了数据库操作(消息检查、标记消息为已读)
4. 添加了后端接口(获取消息中心的数据库`messages`、标记消息为已读`mark_message_read`)

### 2024-12-14(初步完成了消息中心大概的功能)
1. 标记全部消息为已读、删除指定消息
2. <u>现在数据库的外键连接不太完善，需要考虑是要添加外键还是在进行部分操作时同时操作多张表</u>
3. 对消息进行同步，当用户在博客底下发布评论`/add_comment`时，对评论表和消息表进行同步操作
4. 当用户删除消息中心的消息时，对评论表没有影响；若是发布评论的用户删除评论时，消息表中的消息同步进行删除。

### 2024-12-15(新增博客点赞功能)
1. 在评论按钮的上方添加了一个点赞的ui
2. 新增数据库点赞表(将博客id和~~用户id~~`取消了用户id作为外键，用户注销同时删除所有点赞我认为不太合理`作为外键，当博客或用户删除、注销后，对应的点赞记录也会删除)，点赞类以及相应的部分数据库操作代码
3. 直接使用`count`获取特定博客的点赞总数，不额外添加总数字段，<u>后面可能看情况添加redis？</u>
4. 今天前端代码不知道什么鬼，后端返回了点赞的总数，但是前端死活不显示。太晚了，明天继续

### 2024-12-16()
1. 昨天点赞总数的前端代码给我整蒙了，今天看了一下容器的知识，直接将点赞按钮和点赞总数放在了同一个容器里面。能成功显示
2. 同理，也可以将评论按钮的容器和评论总数的容器放在一个新的容器。评论总数不需要调用新的接口，直接使用`fetchComments()`获得到的评论数组总长度就行了
3. 将游客和用户页面隔离，游客：只能得知当前博客总点赞数，无法点赞   用户：可看可点
4. 新加了一个获取博客总点赞的接口，前面获取总点赞的是集成到用户点赞的接口里面的
5. <u>进行了一下渗透测试，后期要补上过滤规则才行</u>

### 2024-12-19(整了个nginx进行反向代理)
1. 申请了个域名，不过还没备案暂时无法使用
2. 使用nginx进行反向代理，这样在输入域名的时候可以将默认到80端口的流量转发到博客平台使用的端口(等域名正式可以投入使用了，可以修改配置`/etc/nginx/nginx.conf`禁止外界直接访问博客服务的端口，只能经过nginx的转发)  <u>这样可以在nginx这边进行配置，对恶意流量进行拦截？不过直接在后端那里检测拦截原理应该是一样的，区别只是自己敲代码还是用人家开源的罢了</u>

### 2024-12-29(什么都没做)
1. 我算是发现了，做记录之后会感觉时间过的飞快，这十天里面我居然什么功能都没加！不可思议。。。在我刚打完这几个字后，又像是过了好久，感觉上次写这个项目还是在好久好久之前。

### 2025-1-25 （今天又具体的看了一下代码，线程池的模板类有点多余，用处不大，后期看要不要将这个类写死）

### 2025-1-26-28
找到了无法上传图片的问题所在
读缓冲区的大小太小2048，没有办法存储图片这么大的数据
解决方法：
增加读缓冲区的大小（写死的，目前是使用了这种）
循环读取数据？但是这种应该也是收到读缓冲区的影响
动态拓展缓冲区（这个还不错，后面可以考虑这个动态内存分配，因为前面的固定缓冲区大小，会额外占用较多的内存）

自己整的这个没办法解析图片，打算使用boost现成的库函数进行解析

今天后续又发现了新的问题，前期测试时，因post请求体只有一行，没有考虑到请求体多行的情况，因此在传输文件时，会导致数据读取不完全。
后续修改：可以将数据分块读取，然后拼接起来。至于数据是否完整，可以根据Content-Length字段进行判断。

还是不对，这边本身就已经对请求体的大小进行比较了，但是请求体的存储一直有问题，没办法存储完整的数据
现在主要的问题就是没办法获取完整的请求体数据！！！！！
请求体应该一次性读取完毕，逐行读取可能导致后续的解析错误

经过测试，从socked读取的数据可以直接存储在字符数组中，不用担心会被'\0'截断，但是在后续对于数据的操作会导致数据被截断，主要是
if(m_read_idx - m_content_start >= m_content_length){
                    text = m_read_buf + m_content_start;
                    cout << strlen(text) << endl;
                    LOG_INFO("%s", text);
                    text[m_content_length] = '\0';
                    m_string = text;
                    return do_request();
                }
虽然text可以存储到请求体的数据，但是在后续的操作中，char* text这个类型会导致数据被截断，

ok，将数据类型从char* 转换为string可以解决这个图片上传这个问题（主要的原因就是对C字符串操作时，二进制数据中的'\0'会影响到数据的检测）。
使用deepseek帮忙重写了string http_conn::handle_file_upload(const string& boundary, const string& body, const string& upload_dir)
这个函数。这个ai的思考过程对于程序员来说感觉帮助很大，虽然会有重复的内容，但是有助于缕清思路。

### 2025-2-9(对注册功能进行进一步完善)
注册（blog_register.html）：
1. 用户名要进行唯一性检查，如果已经存在该用户名，则提示用户该用户名已被注册。
2. 用户名只允许字母、数字（取消中文用户名，有需要再在里面单独新加一个昵称）禁止特殊字符，同时设定长度限制（3-20个字符）
3. 密码也要进行验证，不低于八位，同时至少要有两种字符（字母、数字、特殊符号）
4. 密码在保存时要进行加密存储（如哈希+盐值？），还要进行加密传输（HTTPS）
5. 同一用户在短时间内连续失败5次，则临时封禁登录（如10分钟）

### 2025-2-17()
1. 修复了一个bug，当用户登录后，查询自己的个人信息时，有可能查看到其他用户的信息。原因：因为部分用户的部分字段可能为空，在进行数据库操作时没有考虑到，因此导致的查询出错。
2. 注册的前端界面已全部完成，包括所有的检测。
3. 添加了后端的用户名和密码检测,若绕过前端代码，则后端代码的检测返回统一的错误页面。
4. 只有当：
  * 用户名格式正确
  * 用户名未被占用
  * 密码符合要求
  * 两次密码一致  
注册按钮才会被启用，否则点击无效！🎯

### 2025-2-18()
1. 加密存储使用哈希+盐值，用的是https://github.com/trusch/libbcrypt库。保留初始的登录认证，便于测试if (BCrypt::validatePassword(password, stored_hash) || users[name] == password)。后续删除users[name] == password，只保留哈希的认证
2. nginx执行文件：/usr/local/nginx/sbin  暂停：./nginx -s stop 启动：./nginx 重启：./nginx -s reload
3. 使用nginx进行反向代理，使客户端数据传输到服务器时是使用的HTTPS。
客户端-->nginx（HTTPS）
nginx-->C++服务器(HTTP)
确保了数据的传输安全

### 2025-2-22()
1. 添加了管理员后端界面（目前只有前端），也需要进行登录才可使用，博客页面不提供管理员页面的入口，只有管理员才会知道，普通用户可以误入管理员登录界面。
2. 添加了管理员表，以及部分的数据库操作内容。
3. 有个bug，cookie总是存储不进管理员的username，但是可以存session。
是忽略了一个问题，Cookie是使用静态变量存储具体的cookie值的，虽然创建了新的cookie_admin实例，但是实际上使用的还是同一个存储点。
4. 直接把Cookie类copy了，新建一个Cookie_admin用于管理管理员的cookie（虽蠢但快。。。）
5. 有个新问题，只有当用户点击logout进行注销后，才会进行重定向将客户端的cookie置空。当在同一个浏览器先登录管理员账号后，获取了cookie，然后直接访问用户的页面，能够直接进入用户页面，并且发布博客。
6. 可以通过设置path路径，
角色	Cookie 名称示例	作用域
管理员	admin_session_id	Path=/admins_login
用户	user_session_id	Path=/blog
访问 /admins_login/* 时，浏览器自动发送 admin_session_id
访问 /blog/* 时，浏览器自动发送 user_session_id

### 2025-2-23()
1. 需要注意的是，因为博客平台和管理员后台的Path路径不同，因此在清除cookie时要注意，使用path="/admins"路径是无法清除path="/"的cookie的
2. 管理员和用户同时登录，当管理员的注销时，会导致用户的cookie被同步清除(应该管理员的注销path路径设置为"/")。但是只清除了客户端的cookie，没有清除服务器的，导致该用户无法正常登录。
3. 管理员和用户之间的转换会有点问题，得慢慢调了。。。。

### 2025-2-26
1. 完成管理员后台的仪表盘。
2. 完成管理员文章管理的前端内容，后端数据库有部分表没有对应的列，暂时使用死数据进行替换。

新增管理员添加用户
改进的json字符串的解析函数

### 2025-3-6
1. 新增管理员修改用户信息、包括用户密码。删除用户
2. 对几个数据库操作进行完善，减少了bug的出现。
3. 用户管理全部完成，经过功能测试无bug出现!!!!!!!!这个是最完善的，其它模块后面要参考这个的数据库操作，ui界面等
4. 因为几个模块的代码全都放在一个js文件中，因此模块出现了部分冲突。在命名时要将各个id加上专门名称。如userButtom。

### 2025-3-7
1. 今天遇到的一个问题，前端发送请求，要求后端返回 按照使用了不同分类的博客数量 进行返回。即：使用了不同分类的博客总数。
解决了，直接将博客数量分出来，get_categories_by_articles_count_and_search。不过当分类过多时，会有性能问题，因为在函数里面还会为每一个分类查询当前分类拥有的博客总数。后续可以考虑在分类表添加一个博客总数的字段？
2. 完成分类管理模块

### 2025-3-8
1. 自己写的json解析使我破防，抓紧安装了#include <nlohmann/json.hpp>


### 2025-3-14(这里记录管理员后台的总进度)
1. 仪表盘已完成，显示文章、用户、评论、点赞总数
2. 文章管理已完成，~~还有一个浏览量要思考如何实现（后续估计是在博客表中新加一个浏览量的字段）~~(已增加)
3. 评论管理已完成，~~后续在后端返回评论用户的Email就行了~~搞定，直接把返回Email删了，反正没啥必要
4. 用户管理已完成，~~还差一个最近登录的字段，还有文章总数~~。已搞定
5. 分类管理要~~改一下js代码，对js代码进行封装~~已完成
6. 标签管理已完成

### 2025-3-16
1. 今天进行压力测试，发现只要客户端超过一个，服务器会直接崩溃，返回段错误。
使用``valgrind``工具进行内存调试，但是存在较多的内存泄漏。。。。无法发现最根本的问题（不是很会看）。
故使用``gdb``进行调试，直接返回了出现问题的堆栈。
Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7ffff3b7a700 (LWP 97841)]
0x000000000042d4cd in std::_List_const_iterator<st_mysql*>::operator++ (this=0x7ffff3b79d70) at /usr/include/c++/4.8.2/bits/stl_list.h:235
235             _M_node = _M_node->_M_next;
Missing separate debuginfos, use: debuginfo-install glibc-2.17-326.el7_9.3.x86_64 libgcc-4.8.5-44.el7.x86_64 libstdc++-4.8.5-44.el7.x86_64  

主要原因：链表迭代器自增操作，但是迭代器指向的链表节点已被释放，访问的是无效内存
解决方案如下：👇**需注意这个操作治标不治本，但现在先暂时这么操作**
```cpp
MYSQL *connection_pool::GetConnection()
{
	MYSQL *con = NULL;

	if (connList.empty()){  // 这里原本是0 == connList.size() 需要对链表进行遍历，极高的增加了访问到下面被pop_front()掉的内存概率。而empty()直接检查头指针，效率更高，能有效降低多线程竞争的概率
		LOG_ERROR("The database connection pool is empty!");
		return NULL;
	}

	reserve.wait();
	
	lock.lock();

	con = connList.front();
	connList.pop_front(); // 这里pop掉了，如果其它线程刚好使用connList.size()进行遍历，就有可能访问到这个刚被释放掉的内存

	--m_FreeConn;
	++m_CurConn;

	lock.unlock();
	return con;
}
```

### 2025-3-18
1. 完成标签管理，不得不说，cursor确实是好用，不过tap的使用还是要注意代码，不然还是有挺多缺漏。


### 2025-3-23
1. 对页面进行大的调整，使用新的ui
2. 博客首页大致完成，注意图片展示，后续要在blog表加一个图片的字段(已完成)
3. 登录页面大致完成，后续可以补充找回密码和使用其它方式登录
4. 注册页面大致完成，服务条款和隐私政策先不用管
5. 博客详情页，收藏功能、友链跳转、热门标签可以先隐藏。先取消点击标签跳转的功能
6. 博客创建页，

### 2025-3-24
1. 今天遇到一个bug，还是与数据库相关。
``blog.set_thumbnail(thumbnail_is_null ? "" : string(thumbnail, thumbnail_length));``
虽然使用了thumbnail_is_null标志，但问题在于当该列为NULL时，thumbnail_length可能包含一个未定义或非常大的值，**因为MySQL不会为NULL列设置长度值**。当尝试使用这个可能非常大的长度值创建一个新的string对象时，系统试图分配一块巨大的内存，导致了std::bad_alloc异常。
2. 插个眼，前端发送过来的请求包含图片时，当读缓冲区过小，会导致无法提取到完整的内容，进而导致报错。但如果直接硬编码，会导致读缓冲区占用过多的内容（读缓冲区是写在用户连接类里面的，系统运行就会分配内容），因此要想办法后续动态分配内存
3. 暂时保留缓冲区的固定大小，在前端用户上传文件时，对图片进行压缩。

### 2025-3-28
1. 目前看来，用户的使用界面已经全部完成
2. 还差个人用户中心
3. 管理员后台也要进行相应的完善

### 2025-3-31
1. 暂时看来用户这边是已经全部完成了，后续对cookie的验证进行一下排查
2. 在用户消息中心添加了点赞、评论的信息同步。

### 2025-4-1
1. 对编辑器和博客详情的样式进行修改，能够正常解析显示有序列表和无序列表
2. blog_detail.css的样式会报错，但是排查不出原因。先保留吧，反正能够正常使用。
3. 继续使用html存储到后端，虽然有XSS风险，不过可以添加过滤器。虽然可以转化为Markdown格式，但是在解析的时候会有问题，因此暂时先不转化

### 2025-4-3
1. 添加了评论删除功能
2. 后续先暂时不添加功能，主要是在后端增加新的验证。比如删除博客时，要判断当前博客是否属于该用户。
3. 还有管理员后台也要处理一下

### 2025-4-4
1. 隐藏各页面顶部的搜索框，暂时不实现这个功能
2. 管理员后台管理优化
> 文章管理：进行集成，优化查看博客详情功能
3. 添加了搜索页面的接口，但是先隐藏，暂时不实现这个功能

### 2025-4-7
1. 
> 评论管理：点击所属文章能正确跳转到博客详情
> 优化了管理员后台各功能编辑的模态框
2. 将用户博客总数进行了同步，当博客发布或删除时，会同步进行+1或-1
3. 添加了编辑器格式刷功能
4. 在编辑器中添加删除封面的按钮。当删除掉封面时，直接将封面路径置空。

## 更新日志

### 版本 1.0.0
- 初始版本发布。
- 包括博客发布(Markdown编辑器的集成)、显示。
- 用户的登录、注册。

### 版本 1.1.0
- 使用cookie+session进行会话管理。
- 添加了留言板功能。

### 版本 1.2.0
- 待定。
- 待定。

## 未来规划

### 可扩展性增强
- **支持多数据库系统**：目前仅支持MySQL，未来可以考虑支持PostgreSQL等。
- **支持图像上传和展示**：允许用户上传图片作为博客内容的一部分。

### 性能优化
- **缓存机制**：实现博客内容的缓存，以提高读取速度。
- **负载均衡**：支持水平扩展，分布式部署服务器，增加请求处理能力。

### 未来计划（这部分暂时留存）
- 增加全文搜索功能，支持博客标题、内容、评论的搜索。
- 添加社交分享功能，支持将文章分享到社交平台。
- 支持多语言，扩展为国际化平台。

## 常见问题

### 问：为什么我在浏览器访问时经常遇到页面加载缓慢的情况？
答：可能是由于服务器负载过高或者数据库查询不优化。可以通过增加缓存、优化SQL查询、调整数据库索引来改善。

### 问：如何管理用户的权限？
答：使用基于角色的访问控制（RBAC）来限制不同类型用户（管理员、普通用户）的访问权限。

## 参考文献

- Linux高性能服务器编程，游双著.
- [qinguoyi/TinyWebServer](https://github.com/qinguoyi/TinyWebServer)
